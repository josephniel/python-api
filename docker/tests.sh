#!/bin/sh
echo "======================================================================"
echo "Running Flake8"
echo "======================================================================\n"
flake8 ./api ./tests

echo "======================================================================"
echo "Running MyPy"
echo "======================================================================\n"
cd ./api
mypy __init__.py
cd ../tests
mypy __init__.py
cd ..

echo "======================================================================"
echo "Waiting for test database to finish initialization..."
echo "======================================================================"
until PGPASSWORD=$2 psql -h database -U $1 -d $3 -c '\q'; do
  sleep 1
done
echo "\nDatabase initialized.\n"

echo "======================================================================"
echo "Migrating test database to latest schema..."
echo "======================================================================\n"
flask db upgrade


echo "======================================================================"
echo "Running unit tests..."
echo "======================================================================\n"
nosetests .
